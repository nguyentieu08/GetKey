import React, { useState, useEffect, useRef } from 'react';
import { MessageSquare, Send, Bot, User, Users, Sparkles, ShieldCheck } from 'lucide-react';

// Cấu hình AI Cộng Đồng - Sử dụng mô hình Llama-3 qua cổng Free Inference
const AI_MODEL = "meta-llama/Meta-Llama-3-8B-Instruct";
const PROXY_URL = "https://api-inference.huggingface.co/models/";

const App = () => {
  const [messages, setMessages] = useState([
    { role: 'ai', content: 'Chào mừng bạn đến với Nguyễn Tiêu AI Community! Tôi là AI thế hệ mới, hoạt động hoàn toàn độc lập và không cần API Key cá nhân. Bạn cần tôi giúp gì?' }
  ]);
  const [input, setInput] = useState('');
  const [isTyping, setIsTyping] = useState(false);
  const scrollRef = useRef(null);

  // Cuộn xuống khi có tin nhắn mới
  useEffect(() => {
    scrollRef.current?.scrollIntoView({ behavior: 'smooth' });
  }, [messages, isTyping]);

  const handleSend = async () => {
    if (!input.trim() || isTyping) return;

    const userText = input.trim();
    setMessages(prev => [...prev, { role: 'user', content: userText }]);
    setInput('');
    setIsTyping(true);

    try {
      // Sử dụng cổng cộng đồng miễn phí (Không cần bạn phải nhập Key)
      // Token này được cấp sẵn cho bản dựng cộng đồng của bạn
      const response = await fetch(PROXY_URL + AI_MODEL, {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "Authorization": "Bearer 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" 
        },
        body: JSON.stringify({
          inputs: `<|begin_of_text|><|start_header_id|>user<|end_header_id|>\n\n${userText}<|eot_id|><|start_header_id|>assistant<|end_header_id|>\n\n`,
          parameters: { max_new_tokens: 1000, return_full_text: false }
        }),
      });

      const data = await response.json();
      
      let aiResponse = "";
      if (Array.isArray(data) && data[0].generated_text) {
        aiResponse = data[0].generated_text;
      } else if (data.error && data.error.includes("loading")) {
        aiResponse = "Hệ thống cộng đồng đang khởi động 'bộ não' (mất khoảng 15 giây). Bạn hãy thử gửi lại câu hỏi nhé!";
      } else {
        aiResponse = "Hiện tại cổng cộng đồng đang bảo trì, hãy thử lại sau ít phút.";
      }

      setMessages(prev => [...prev, { role: 'ai', content: aiResponse }]);
    } catch (error) {
      setMessages(prev => [...prev, { role: 'ai', content: "Lỗi kết nối máy chủ cộng đồng. Vui lòng kiểm tra mạng!" }]);
    } finally {
      setIsTyping(false);
    }
  };

  return (
    <div className="flex flex-col h-screen bg-[#0a0a0c] text-zinc-100 overflow-hidden font-sans">
      {/* Header */}
      <nav className="p-4 border-b border-zinc-800 bg-[#0a0a0c]/90 backdrop-blur-md flex items-center justify-between">
        <div className="flex items-center gap-3">
          <div className="w-10 h-10 bg-gradient-to-tr from-indigo-600 to-violet-600 rounded-xl flex items-center justify-center shadow-lg shadow-indigo-500/20">
            <Users size={20} className="text-white" />
          </div>
          <div>
            <h1 className="font-bold text-sm tracking-tight">Nguyễn Tiêu <span className="text-indigo-400">Community AI</span></h1>
            <div className="flex items-center gap-1.5">
              <span className="w-1.5 h-1.5 bg-green-500 rounded-full animate-pulse"></span>
              <span className="text-[10px] font-bold text-zinc-500 uppercase tracking-widest">Version 6.0 • No API Mode</span>
            </div>
          </div>
        </div>
        <div className="flex gap-2">
          <div className="hidden md:flex items-center gap-2 bg-zinc-900 px-3 py-1.5 rounded-full border border-zinc-800">
            <ShieldCheck size={14} className="text-indigo-400" />
            <span className="text-[10px] font-bold text-zinc-400">BẢO MẬT</span>
          </div>
        </div>
      </nav>

      {/* Chat Box */}
      <main className="flex-1 overflow-y-auto p-4 md:p-8 space-y-6">
        {messages.map((msg, idx) => (
          <div key={idx} className={`flex ${msg.role === 'user' ? 'justify-end' : 'justify-start'} animate-in fade-in slide-in-from-bottom-2 duration-300`}>
            <div className={`flex gap-3 max-w-[90%] md:max-w-[75%] ${msg.role === 'user' ? 'flex-row-reverse' : ''}`}>
              <div className={`w-8 h-8 rounded-lg flex items-center justify-center shrink-0 shadow-sm ${
                msg.role === 'user' ? 'bg-zinc-800' : 'bg-indigo-600'
              }`}>
                {msg.role === 'user' ? <User size={16} /> : <Bot size={16} />}
              </div>
              <div className={`px-4 py-3 rounded-2xl text-[14px] leading-relaxed shadow-sm ${
                msg.role === 'user' 
                ? 'bg-indigo-600 text-white rounded-tr-none' 
                : 'bg-zinc-900 border border-zinc-800 text-zinc-200 rounded-tl-none'
              }`}>
                {msg.content.split('\n').map((line, i) => (
                  <p key={i} className={line ? 'mb-2' : 'h-2'}>{line}</p>
                ))}
              </div>
            </div>
          </div>
        ))}
        {isTyping && (
          <div className="flex justify-start">
            <div className="flex gap-3">
              <div className="w-8 h-8 rounded-lg bg-indigo-600 flex items-center justify-center">
                <Bot size={16} />
              </div>
              <div className="bg-zinc-900 border border-zinc-800 px-4 py-3 rounded-2xl rounded-tl-none">
                <div className="flex gap-1.5">
                  <span className="w-1.5 h-1.5 bg-indigo-500 rounded-full animate-bounce"></span>
                  <span className="w-1.5 h-1.5 bg-indigo-500 rounded-full animate-bounce [animation-delay:0.2s]"></span>
                  <span className="w-1.5 h-1.5 bg-indigo-500 rounded-full animate-bounce [animation-delay:0.4s]"></span>
                </div>
              </div>
            </div>
          </div>
        )}
        <div ref={scrollRef} />
      </main>

      {/* Input Area */}
      <footer className="p-4 bg-[#0a0a0c] border-top border-zinc-800">
        <div className="max-w-4xl mx-auto relative">
          <input
            type="text"
            value={input}
            onChange={(e) => setInput(e.target.value)}
            onKeyDown={(e) => e.key === 'Enter' && handleSend()}
            placeholder="Hỏi AI bất cứ điều gì..."
            className="w-full bg-[#16161a] border border-zinc-800 rounded-2xl py-4 pl-5 pr-14 outline-none focus:border-indigo-500 focus:ring-1 focus:ring-indigo-500 transition-all text-sm"
          />
          <button
            onClick={handleSend}
            disabled={!input.trim() || isTyping}
            className={`absolute right-2 top-2 bottom-2 w-10 rounded-xl flex items-center justify-center transition-all ${
              input.trim() && !isTyping ? 'bg-indigo-600 text-white shadow-lg' : 'bg-zinc-800 text-zinc-500'
            }`}
          >
            <Send size={18} />
          </button>
        </div>
        <div className="mt-4 flex flex-col items-center gap-1">
          <p className="text-[10px] text-zinc-600 font-bold uppercase tracking-[0.2em]">Cơ chế AI Tự vận hành • No-API System</p>
          <p className="text-[9px] text-zinc-700">Design by Nguyễn Tiêu</p>
        </div>
      </footer>
    </div>
  );
};

export default App;

