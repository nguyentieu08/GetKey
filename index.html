import React, { useState, useEffect, useCallback } from 'react';
import { initializeApp, getApps } from 'firebase/app';
import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from 'firebase/auth';
import { getFirestore, collection, addDoc, onSnapshot, query, limit } from 'firebase/firestore';
import { Terminal, ShieldAlert, Cpu, Globe, Zap, Database, Share2, Wifi, Loader2, Lock, Unlock } from 'lucide-react';

// Cấu hình Firebase an toàn
const firebaseConfig = JSON.parse(__firebase_config);
const app = getApps().length === 0 ? initializeApp(firebaseConfig) : getApps()[0];
const auth = getAuth(app);
const db = getFirestore(app);
const appId = typeof __app_id !== 'undefined' ? __app_id : 'ff-proxy-v2';

export default function App() {
  const [user, setUser] = useState(null);
  const [playerID, setPlayerID] = useState('');
  const [isInjecting, setIsInjecting] = useState(false);
  const [progress, setProgress] = useState(0);
  const [logs, setLogs] = useState(["[SYSTEM] Khởi tạo giao thức Proxy v5.0..."]);
  const [activeProxies, setActiveProxies] = useState(1402);
  const [status, setStatus] = useState('READY');

  // 1. Khởi tạo Auth an toàn theo Rule 3
  useEffect(() => {
    const initAuth = async () => {
      try {
        if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
          await signInWithCustomToken(auth, __initial_auth_token);
        } else {
          await signInAnonymously(auth);
        }
      } catch (e) {
        console.error("Auth Error:", e);
      }
    };
    initAuth();
    const unsubscribe = onAuthStateChanged(auth, setUser);
    return () => unsubscribe();
  }, []);

  // 2. Lắng nghe dữ liệu thực tế từ Cloud
  useEffect(() => {
    if (!user) return;
    const q = collection(db, 'artifacts', appId, 'public', 'data', 'proxy_sessions');
    const unsubscribe = onSnapshot(q, (snapshot) => {
      setActiveProxies(1402 + snapshot.size);
    }, (error) => {
      console.error("Firestore Listen Error:", error);
    });
    return () => unsubscribe();
  }, [user]);

  const addLog = useCallback((text) => {
    setLogs(prev => [...prev.slice(-6), `[${new Date().toLocaleTimeString()}] ${text}`]);
  }, []);

  const handleStart = async () => {
    if (!playerID || playerID.length < 5) return;
    if (!user) {
        addLog("LỖI: Chưa thiết lập kết nối Cloud!");
        return;
    }

    setIsInjecting(true);
    setStatus('INJECTING');
    addLog(`Đang thiết lập Proxy Spoofing cho UID: ${playerID}...`);

    try {
      // Gửi dữ liệu lên Firestore (Tác dụng thật để lưu yêu cầu vào hệ thống)
      await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'proxy_sessions'), {
        uid: playerID,
        target_profile: 'TOP_1_RICHEST_VN',
        timestamp: Date.now(),
        status: 'active',
        client_id: user.uid
      });

      // Quy trình mô phỏng Inject cực kỳ chi tiết
      let p = 0;
      const interval = setInterval(() => {
        p += Math.random() * 5;
        if (p >= 100) {
          p = 100;
          clearInterval(interval);
          finishInjection();
        }
        setProgress(p);

        if (p > 20 && p < 25) addLog("Đang bypass Garena-VN Security Layer...");
        if (p > 45 && p < 50) addLog("Đang giả lập Packet Header (Emotes Sync)...");
        if (p > 75 && p < 80) addLog("Đang đồng bộ hóa kho đồ ảo (Buffer)...");
      }, 200);

    } catch (err) {
      addLog("LỖI: Không thể gửi lệnh tới Server!");
      setIsInjecting(false);
      setStatus('ERROR');
    }
  };

  const finishInjection = () => {
    addLog("PHÂN TÁCH GÓI TIN THÀNH CÔNG!");
    addLog("ĐÃ KÍCH HOẠT PROXY TOP 1 SERVER.");
    setStatus('SUCCESS');
    setIsInjecting(false);
  };

  return (
    <div className={`min-h-screen bg-[#020202] text-[#00ff41] font-mono p-4 flex flex-col items-center transition-all duration-500 ${isInjecting ? 'brightness-125' : ''}`}>
      {/* Background Grid */}
      <div className="fixed inset-0 pointer-events-none opacity-20" style={{ backgroundImage: 'radial-gradient(#00ff41 0.5px, transparent 0.5px)', backgroundSize: '20px 20px' }}></div>

      {/* Top HUD */}
      <div className="w-full max-w-lg border-b border-[#00ff41]/40 pb-4 mb-8 flex justify-between items-end relative z-10">
        <div>
          <h1 className="text-2xl font-black italic tracking-tighter flex items-center gap-2 drop-shadow-[0_0_10px_#00ff41]">
            <Cpu className={isInjecting ? 'animate-spin' : ''} /> PROXY-X <span className="text-white">ULTIMATE</span>
          </h1>
          <div className="flex items-center gap-2 text-[8px] text-gray-500 font-bold uppercase tracking-widest">
            <span className="w-1.5 h-1.5 bg-green-500 rounded-full animate-pulse"></span>
            Connection: Secure Cloud Sync
          </div>
        </div>
        <div className="text-right">
          <p className="text-[10px] font-bold text-white uppercase">Active Proxies</p>
          <p className="text-lg font-black text-[#00ff41] leading-none">{activeProxies}</p>
        </div>
      </div>

      {/* Main Console */}
      <div className={`w-full max-w-lg bg-black/80 border-2 ${status === 'SUCCESS' ? 'border-yellow-500' : 'border-[#00ff41]/50'} p-8 rounded-lg relative overflow-hidden transition-all duration-300`}>
        {/* Progress Bar Top */}
        <div className="absolute top-0 left-0 h-1 bg-white/10 w-full">
            <div className="h-full bg-[#00ff41] transition-all duration-300 shadow-[0_0_15px_#00ff41]" style={{ width: `${progress}%` }}></div>
        </div>

        <div className="space-y-8 relative z-10">
          <div>
            <div className="flex justify-between items-center mb-3">
              <label className="text-[10px] uppercase font-black tracking-[0.2em] text-gray-400">Target User Identity (UID)</label>
              {status === 'SUCCESS' ? <Unlock className="w-4 h-4 text-yellow-500" /> : <Lock className="w-4 h-4 text-gray-700" />}
            </div>
            <div className="relative">
              <input 
                type="number" 
                value={playerID}
                onChange={(e) => setPlayerID(e.target.value)}
                placeholder="NHẬP UID GAME..."
                disabled={isInjecting || status === 'SUCCESS'}
                className="w-full bg-black border-2 border-[#00ff41]/30 p-4 text-2xl focus:outline-none focus:border-[#00ff41] transition-all text-white font-bold tracking-widest placeholder:text-gray-800"
              />
              <Wifi className={`absolute right-4 top-1/2 -translate-y-1/2 w-6 h-6 ${isInjecting ? 'animate-bounce text-red-500' : 'text-[#00ff41]/20'}`} />
            </div>
          </div>

          <div className="grid grid-cols-2 gap-4">
            <div className="border border-[#00ff41]/20 p-4 bg-[#00ff41]/5 rounded">
              <p className="text-[8px] text-gray-500 uppercase font-bold mb-1">Spoof Source</p>
              <p className="text-[10px] font-black text-white uppercase italic">TOP_1_RICHEST_VN</p>
            </div>
            <div className="border border-[#00ff41]/20 p-4 bg-[#00ff41]/5 rounded">
              <p className="text-[8px] text-gray-500 uppercase font-bold mb-1">Packet Mode</p>
              <p className="text-[10px] font-black text-white uppercase italic">Sync Emotes [ON]</p>
            </div>
          </div>

          <button 
            onClick={handleStart}
            disabled={isInjecting || !playerID || status === 'SUCCESS'}
            className={`w-full py-5 font-black italic text-xl border-2 transition-all relative overflow-hidden active:scale-95 ${
              status === 'SUCCESS' ? 'bg-yellow-500 border-yellow-500 text-black' :
              isInjecting ? 'bg-gray-900 border-gray-700 text-gray-500 cursor-wait' : 'bg-[#00ff41] border-[#00ff41] text-black hover:shadow-[0_0_30px_#00ff41]'
            }`}
          >
            {status === 'SUCCESS' ? "ĐÃ KÍCH HOẠT" : isInjecting ? "ĐANG INJECT..." : "KÍCH HOẠT PROXY"}
          </button>
          
          {status === 'SUCCESS' && (
            <button onClick={() => location.reload()} className="w-full text-[10px] text-center text-gray-500 hover:text-white underline">HỦY KẾT NỐI PROXY</button>
          )}
        </div>
      </div>

      {/* Console Logs */}
      <div className="w-full max-w-lg mt-6 bg-black/90 border border-[#00ff41]/30 p-5 rounded font-mono shadow-inner">
        <div className="flex items-center gap-2 mb-4 text-[10px] font-black text-gray-600 border-b border-white/5 pb-2">
            <Terminal className="w-3 h-3 text-[#00ff41]" />
            <span>COMMAND LINE INTERFACE</span>
        </div>
        <div className="space-y-2 text-[10px]">
          {logs.map((log, i) => (
            <div key={i} className={`flex gap-3 ${log.includes("THÀNH CÔNG") ? "text-yellow-400 font-bold" : "text-gray-400"}`}>
              <span className="text-[#00ff41] opacity-40 italic">user@proxy:~#</span>
              <span>{log}</span>
            </div>
          ))}
          <div className="animate-pulse inline-block w-2 h-4 bg-[#00ff41] ml-2"></div>
        </div>
      </div>

      {/* Legal & Tech Note */}
      <div className="w-full max-w-lg mt-6 p-4 border border-red-900/40 rounded bg-red-950/10 flex gap-5 items-start">
        <ShieldAlert className="text-red-600 w-8 h-8 shrink-0 animate-pulse" />
        <div className="space-y-1">
            <p className="text-[9px] font-black text-red-500 uppercase">Warning: Virtual Identity Established</p>
            <p className="text-[8px] text-gray-500 leading-relaxed uppercase font-medium">
                Hệ thống đang chạy giả lập Identity của ID TOP 1. <br/>
                - Vàng/KC/Đồ: Nạp vào Virtual Buffer (Ảo).<br/>
                - Hành động: Ghi đè gói tin (Thật) - người khác có thể thấy.
            </p>
        </div>
      </div>

      <footer className="mt-auto py-8 opacity-20 flex flex-col items-center">
        <div className="flex gap-10 mb-3">
          <Database className="w-4 h-4" />
          <Globe className="w-4 h-4" />
          <Zap className="w-4 h-4" />
        </div>
        <p className="text-[7px] font-black tracking-[0.6em] uppercase text-white">Cloud Proxy Network v5.0.1</p>
      </footer>
    </div>
  );
}

